{% extends "base.html" %}
{% load l10n %} {# Для форматирования чисел, если нужно #}

{% block title %}Статус задачи: {{ task_db_obj.task_id|truncatechars:15 }}...{% endblock %}

{% block content %}
<h2>Статус задачи <span id="task-id-display">{{ task_db_obj.task_id }}</span></h2>

<div class="task-details">
    <p><strong>ID Задачи:</strong> <span id="task-id-data">{{ task_data.task_id }}</span></p>
    <p><strong>От:</strong> <span id="start-port-name">{{ task_data.start_port_name }}</span></p>
    <p><strong>До:</strong> <span id="end-port-name">{{ task_data.end_port_name }}</span></p>
    <p><strong>Статус:</strong> <strong id="task-status-display">{{ task_data.status_display }}</strong></p>
    <p><strong>Создана:</strong> <span id="created-at">{{ task_data.created_at|date:"d.m.Y H:i:s" }}</span></p>
    <p><strong>Обновлена:</strong> <span id="updated-at">{{ task_data.updated_at|date:"d.m.Y H:i:s" }}</span></p>
    <p><small>Источник данных: <span id="data-source">{{ task_data.source }}</span></small></p>
</div>

<div id="result-container">
    {% if task_data.status_code == "COMPLETED" %}
        <h3>Результаты расчета:</h3>
        <p><strong>Общее расстояние:</strong> 
           <span id="result-distance">
             {% if task_data.result_distance is not None %}
               {{ task_data.result_distance|floatformat:2 }} морских миль
             {% else %}
               N/A
             {% endif %}
           </span>
        </p>
        <h4>Маршрут:</h4>
        <ul id="result-path-list">
            {% if task_data.result_path_details %}
                {% for port_detail in task_data.result_path_details %}
                    <li>{{ port_detail.name }} (ID: {{ port_detail.id }})</li>
                {% endfor %}
            {% else %}
                <li>Путь не определен.</li>
            {% endif %}
        </ul>
    {% elif task_data.status_code == "FAILED" %}
        <h3>Ошибка выполнения задачи:</h3>
        <p style="color: red;" id="error-message-display">{{ task_data.error_message|default:"Неизвестная ошибка." }}</p>
    {% elif task_data.status_code == "PENDING" or task_data.status_code == "PROCESSING" %}
        <p id="loading-message">Задача в обработке, пожалуйста, подождите... Статус будет обновлен автоматически.</p>
    {% endif %}
</div>

<p style="margin-top: 20px;">
    <a href="{% url 'routes:calculate_task_create' %}">Рассчитать другой маршрут</a>
</p>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const taskId = "{{ task_db_obj.task_id }}"; // Получаем ID из объекта Django модели
    const taskStatusCodeField = document.getElementById('task-status-code'); // Не используется в текущем HTML, но может быть полезно
    const taskStatusDisplayField = document.getElementById('task-status-display');
    const updatedAtField = document.getElementById('updated-at');
    const resultContainer = document.getElementById('result-container');
    const dataSourceField = document.getElementById('data-source'); // Для отображения источника
    const loadingMessage = document.getElementById('loading-message');

    let currentStatusCode = "{{ task_data.status_code }}";

    function updatePage(data) {
        if (taskStatusDisplayField) taskStatusDisplayField.textContent = data.status_display;
        if (updatedAtField) updatedAtField.textContent = new Date(data.updated_at).toLocaleString('ru-RU');
        if (dataSourceField) dataSourceField.textContent = data.source || 'db'; // Источник данных

        currentStatusCode = data.status_code;

        let resultHtml = '';
        if (data.status_code === "COMPLETED") {
            resultHtml += '<h3>Результаты расчета:</h3>';
            resultHtml += `<p><strong>Общее расстояние:</strong> <span id="result-distance">${data.result_distance !== null ? parseFloat(data.result_distance).toFixed(2) + ' морских миль' : 'N/A'}</span></p>`;
            resultHtml += '<h4>Маршрут:</h4><ul id="result-path-list">';
            if (data.result_path_details && data.result_path_details.length > 0) {
                data.result_path_details.forEach(port => {
                    resultHtml += `<li>${port.name} (ID: ${port.id})</li>`;
                });
            } else {
                resultHtml += '<li>Путь не определен.</li>';
            }
            resultHtml += '</ul>';
            if (loadingMessage) loadingMessage.style.display = 'none';
        } else if (data.status_code === "FAILED") {
            resultHtml += '<h3>Ошибка выполнения задачи:</h3>';
            resultHtml += `<p style="color: red;" id="error-message-display">${data.error_message || 'Неизвестная ошибка.'}</p>`;
            if (loadingMessage) loadingMessage.style.display = 'none';
        } else if (data.status_code === "PENDING" || data.status_code === "PROCESSING") {
            if (loadingMessage) {
                 loadingMessage.style.display = 'block';
                 loadingMessage.textContent = `Задача в обработке (${data.status_display}), пожалуйста, подождите... Статус будет обновлен автоматически.`;
            } else {
                 resultHtml = `<p id="loading-message">Задача в обработке (${data.status_display}), пожалуйста, подождите... Статус будет обновлен автоматически.</p>`;
            }
        }
        if(resultContainer) resultContainer.innerHTML = resultHtml;
    }

    function fetchStatus() {
        if (currentStatusCode === 'COMPLETED' || currentStatusCode === 'FAILED') {
            // console.log("Задача завершена, опрос остановлен.");
            return;
        }

        fetch("{% url 'routes:task_status' task_db_obj.task_id %}", {
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': "{{ csrf_token }}" // Если нужен CSRF для GET AJAX, хотя обычно нет
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok ' + response.statusText);
            }
            return response.json();
        })
        .then(data => {
            // console.log("Получены данные статуса:", data);
            updatePage(data);
        })
        .catch(error => {
            console.error('Ошибка при получении статуса задачи:', error);
            // Можно остановить опрос или показать сообщение об ошибке пользователю
        });
    }

    // Инициализация страницы данными, переданными из Django
    // updatePage({{ task_data_json|safe }}); // Если бы передавали JSON напрямую

    if (currentStatusCode === 'PENDING' || currentStatusCode === 'PROCESSING') {
        setInterval(fetchStatus, 5000); // Опрашивать каждые 5 секунд
        // fetchStatus(); // Можно вызвать сразу для обновления, если начальные данные могут быть из Redis
    }
});
</script>
{% endblock %}