# RoutePlan Service Overview

Данный проект, RoutePlan, предоставляет функциональность для расчета морских маршрутов. Он предназначен для определения оптимальных расстояний между заданными портами. Дополнительно, для пользователей с соответствующими полномочиями, система способна вычислять предполагаемое время в пути на основе заданной скорости судна.

## Принцип работы

Система RoutePlan реализована как набор взаимосвязанных сервисов. Каждый сервис выполняет определенную роль, обеспечивая модульность и масштабируемость:

### Routes Management Service (Django)

Это основное веб-приложение, с которым взаимодействует пользователь через браузер. Оно управляет учетными записями пользователей (регистрация, аутентификация) и обеспечивает интерфейс для работы с маршрутами.
*   Регистрация пользователей: При регистрации пользователь по умолчанию получает роль "Гость".
*   Создание задач: Пользователи могут отправлять запросы на расчет маршрута между портами.
*   Просмотр статуса: Отображает статус и результаты выполненных расчетов.
*   Ролевая модель доступа:
    *   **Гость**: Может рассчитывать только расстояния.
    *   **Капитан**: Имеет доступ к полю ввода скорости судна для расчета времени в пути.
    *   **Администратор**: Имеет полный контроль над системой, включая управление ролями пользователей через административную панель.

### Routes Calculator Service (FastAPI)

Это вычислительный сервис, ответственный за выполнение сложных алгоритмов (таких как A\*) для поиска оптимального пути.
*   Получение задач: Принимает задачи на расчет от Routes Management Service через систему сообщений Kafka.
*   Выполнение расчетов: Вычисляет не только расстояние, но и время в пути, если в запросе указана скорость судна.
*   Обновление результатов: Сохраняет статус и детальные результаты задачи обратно в центральную базу данных.

### Kafka (Система обмена сообщениями)

Используется как асинхронный брокер сообщений для обеспечения надежного обмена данными между Routes Management Service и Routes Calculator Service.
*   Асинхронное взаимодействие: Позволяет веб-приложению быстро отправлять задачи на расчет, не дожидаясь их выполнения, улучшая отзывчивость пользовательского интерфейса.

### PostgreSQL (База данных)

Является центральным реляционным хранилищем всех данных приложения.
*   Хранение данных: Содержит информацию о портах, сегментах маршрутов, профилях пользователей (включая их роли) и состоянии задач на расчет.


## Развертывание и запуск

Для запуска приложения необходима установленная среда Docker.

### 1. Конфигурация среды (`.env` файл)

В корневой директории проекта (где расположен `compose.yaml`) создайте файл `.env` со следующими переменными:

```ini
DJANGO_SECRET_KEY='ваш_уникальный_секретный_ключ_django'
DJANGO_DEBUG=True

DATABASE_USER=db_user
DATABASE_PASSWORD=123
DATABASE_HOST=db
DATABASE_PORT=5432
DATABASE_NAME=routeplan

KAFKA_BROKER_URL=kafka:9092
KAFKA_REQUEST_TOPIC=route_calculation_requests
KAFKA_CONSUMER_GROUP_ID=route_calculator_group_1


## Функциональное тестирование (Веб-интерфейс)

После успешного развертывания, доступ к основному веб-приложению Django осуществляется по адресу `http://localhost:8000/`.

### 1. Доступ к системе

*   **Главная страница / Форма расчета**: `http://localhost:8000/tasks/create/`
*   **Регистрация нового пользователя**: `http://localhost:8000/users/register/`
*   **Вход в систему**: `http://localhost:8000/accounts/login/`
*   **Выход из системы**: `http://localhost:8000/accounts/logout/`
*   **Административная панель**: `http://localhost:8000/admin/` (доступна после создания суперпользователя).

### 2. Управление ролями пользователей

*   Войдите в Административную панель (`/admin/`) под учетной записью Администратора.
*   В разделе "Authentication and Authorization" выберите "Custom users".
*   Выберите зарегистрированного пользователя (например, того, которого вы зарегистрировали как "Гостя").
*   Измените значение поля "Роль" на "Капитан" и сохраните изменения.

### 3. Расчет маршрутов

*   После входа в систему, перейдите на страницу `http://localhost:8000/tasks/create/`.
*   **Для Гостя**: Будет доступен только выбор портов для расчета расстояния. Поле ввода скорости судна будет скрыто или неактивно.
*   **Для Капитана**: Будет доступно поле ввода "Скорость судна (узлы)". Ввод скорости позволит системе рассчитать предполагаемое время в пути (ETA/ETD) для каждого вейпоинта маршрута.

### 4. Статус задачи

*   После отправки запроса на расчет, система автоматически перенаправит вас на страницу статуса задачи: `http://localhost:8000/tasks/<UUID_задачи>/`
*   Статус задачи обновляется в реальном времени через AJAX.
*   По завершении расчета (статус "Завершено") будут отображены: общее расстояние и, при наличии скорости, детальная информация по вейпоинтам с ETA/ETD.

### 5. Проверка Healthcheck-эндпоинтов

*   **FastAPI Healthcheck**: `http://localhost:8001/health`
    *   **Ожидаемый результат**: JSON-ответ `{"status": "healthy", "service": "RouteCalculatorService"}`.
*   **Django Healthcheck**: `http://localhost:8000/health/`
    *   **Ожидаемый результат**: JSON-ответ `{"status": "healthy"}`.

